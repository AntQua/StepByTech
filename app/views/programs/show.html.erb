<%= render "shared/card_program_details" %>

<div class="steps-list row">
  <% @program.steps.each do |step| %>
    <div class="steps-card col-md-4 mb-4">
      <div class="card h-100 bg-white rounded-4 d-flex flex-column">
        <div class="card-body flex-grow-1">
          <div class="card-title d-flex justify-content-between align-items-center">
            <h3>Step <%= step.step_order %> - <%= step.name %></h3>
          </div>
          <p class="card-text"><%= step.description %></p>
          <%# <p>Debug: <%= step.dates.inspect</p> %>
          <p>Dias das sessões:</p>
          <% if step.dates.present? %>
            <% grouped_dates = step.dates.compact.group_by { |date| date.strftime('%B') } %>
            <% sessions_strings = grouped_dates.map do |month, dates|
              days = dates.map { |date| date.day }.compact.uniq.sort
              next if days.empty?
              formatted_days = if days.length == 1
                days.first.to_s
              else
                days[0...-1].join(', ') + " e #{days.last}"
              end
              "- #{month} dias #{formatted_days}"
            end.reject(&:nil?).join('<br>').html_safe %>
            <%= sessions_strings %>
          <% end %>

          <p class="mt-2">Início: <%= step.hour_start.strftime('%H:%M') if step.hour_start %> | Fim: <%= step.hour_finish.strftime('%H:%M') if step.hour_finish %></p>
        </div>

        <!-- Adding the icon link to the bottom right of the card using Bootstrap -->
        <div class="card-footer border-0 bg-transparent text-end">
          <%= link_to program_step_path(step.program, step) do %>
            <i class="fa-solid fa-circle-info text-success"></i>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
